{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\r\n * Created with @iobroker/create-adapter v2.1.1\r\n */\r\n\r\nimport * as utils from '@iobroker/adapter-core';\r\nimport { defaultFollowerKeysAndValues } from './helper/default-follower-keys-and-values';\r\nimport { IFollower } from './interfaces/follower.interface';\r\nimport { IStream } from './interfaces/stream.interface';\r\nimport { TwitchApi } from './lib/twitch-api';\r\n\r\nconst UPDATE_INTERVAL_IN_MILLISECONDS = 60000;\r\n\r\nclass Twitch extends utils.Adapter {\r\n    private twitchApi: TwitchApi;\r\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\r\n        super({\r\n            ...options,\r\n            name: 'twitch',\r\n        });\r\n        this.on('ready', this.onReady.bind(this));\r\n        this.on('stateChange', this.onStateChange.bind(this));\r\n        this.on('unload', this.onUnload.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Is called when databases are connected and adapter received configuration.\r\n     */\r\n    private async onReady(): Promise<void> {\r\n        if (!this.config.authToken) {\r\n            this.log.error('Auth token is empty - please check instance configuration');\r\n            return;\r\n        }\r\n\r\n        if (!this.config.username) {\r\n            this.log.error('Username is empty - please check instance configuration');\r\n            return;\r\n        }\r\n\r\n        this.twitchApi = new TwitchApi(this.config.authToken, this.config.username, this.log);\r\n\r\n        try {\r\n            await this.twitchApi.initialize();\r\n        } catch (err: any) {\r\n            await this.setStateAsync('info.connection', { val: false, ack: true });\r\n            this.log.error(err);\r\n            return;\r\n        }\r\n\r\n        await this.setStateAsync('info.connection', { val: true, ack: true });\r\n\r\n        await this.createFolder('channels', 'Followed Twitch Channels');\r\n\r\n        this.updateFollowersInStore();\r\n\r\n        this.setInterval(() => {\r\n            this.updateFollowersInStore();\r\n        }, UPDATE_INTERVAL_IN_MILLISECONDS);\r\n    }\r\n\r\n    private async updateFollowersInStore(): Promise<void> {\r\n        this.log.debug('Updating Twich followers');\r\n\r\n        const [followers, liveStreams] = await Promise.all([\r\n            this.twitchApi.getFollowers(),\r\n            this.twitchApi.getLiveStreamsIFollow(),\r\n        ]);\r\n\r\n        if (!followers || followers.length === 0) {\r\n            return;\r\n        }\r\n\r\n        await this.cleanUpOldFollowers(followers);\r\n\r\n        for (const follower of followers) {\r\n            const followerName = follower.broadcaster_name;\r\n\r\n            const streamStatus = liveStreams.find((stream) => {\r\n                return stream.user_name === followerName;\r\n            });\r\n\r\n            const followerChannelId = `channels.${followerName}`;\r\n            await this.createFolder(followerChannelId, 'Followed Twitch Channel', followerName);\r\n            await this.createOrUpdateStates(followerChannelId, streamStatus);\r\n        }\r\n    }\r\n\r\n    private async cleanUpOldFollowers(followers: Array<IFollower>): Promise<void> {\r\n        const channels = await this.getChannelsAsync('channels');\r\n\r\n        const channelsToDelete = channels.filter((channel) => {\r\n            return !followers.find((follower: IFollower) => {\r\n                return follower.broadcaster_name === channel.native.twitchName;\r\n            });\r\n        });\r\n\r\n        for (const channelToDelete of channelsToDelete) {\r\n            this.log.debug(`Cleaning up unfollowed channel: ${channelToDelete._id}`);\r\n            await this.deleteChannelAsync('channels', channelToDelete._id);\r\n        }\r\n    }\r\n\r\n    private async createFolder(id: string, name: string, followerName?: string): Promise<any> {\r\n        await this.setObjectNotExistsAsync(id, {\r\n            type: 'channel',\r\n            common: {\r\n                name: name,\r\n            },\r\n            native: {\r\n                twitchName: followerName,\r\n            },\r\n        });\r\n    }\r\n\r\n    private async createOrUpdateStates(followerId: string, stream: IStream | undefined): Promise<any> {\r\n        for (const [stateNameInStore, defaultValuesAndLocation] of Object.entries(defaultFollowerKeysAndValues)) {\r\n            const stateName = `${followerId}.${stateNameInStore}`;\r\n\r\n            await this.setObjectNotExistsAsync(stateName, {\r\n                type: 'state',\r\n                common: {\r\n                    name: defaultValuesAndLocation.description,\r\n                    type: defaultValuesAndLocation.type as ioBroker.CommonType,\r\n                    role: 'indicator',\r\n                    read: true,\r\n                    write: false,\r\n                },\r\n                native: {},\r\n            });\r\n\r\n            let value = defaultValuesAndLocation.defaultValue;\r\n\r\n            if (stream) {\r\n                if (stateNameInStore === 'online') {\r\n                    value = true;\r\n                } else {\r\n                    value = (stream as any)[defaultValuesAndLocation.findIn];\r\n                }\r\n            }\r\n\r\n            await this.setStateAsync(stateName, { val: value, ack: true });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Is called when adapter shuts down - callback has to be called under any circumstances!\r\n     */\r\n    private onUnload(callback: () => void): void {\r\n        try {\r\n            this.setState('info.connection', { val: false, ack: true });\r\n            callback();\r\n        } catch (e) {\r\n            callback();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Is called if a subscribed state changes\r\n     */\r\n    private onStateChange(id: string, state: ioBroker.State | null | undefined): void {\r\n        if (state) {\r\n            // The state was changed\r\n            this.log.info(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\r\n        } else {\r\n            // The state was deleted\r\n            this.log.info(`state ${id} deleted`);\r\n        }\r\n    }\r\n}\r\n\r\nif (require.main !== module) {\r\n    // Export the constructor in compact mode\r\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Twitch(options);\r\n} else {\r\n    // otherwise start the instance directly\r\n    (() => new Twitch())();\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
