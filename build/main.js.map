{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\n * Created with @iobroker/create-adapter v2.1.1\n */\n\nimport * as utils from '@iobroker/adapter-core';\nimport { defaultFollowerKeysAndValues } from './helper/default-follower-keys-and-values';\nimport { IFollower } from './interfaces/follower.interface';\nimport { IStream } from './interfaces/stream.interface';\nimport { TwitchApi } from './lib/twitch-api';\n\nconst UPDATE_INTERVAL_IN_MILLISECONDS = 60000;\n\nclass Twitch extends utils.Adapter {\n    private twitchApi: TwitchApi;\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\n        super({\n            ...options,\n            name: 'twitch',\n        });\n        this.on('ready', this.onReady.bind(this));\n        this.on('stateChange', this.onStateChange.bind(this));\n        this.on('unload', this.onUnload.bind(this));\n    }\n\n    /**\n     * Is called when databases are connected and adapter received configuration.\n     */\n    private async onReady(): Promise<void> {\n        if (!this.config.authToken) {\n            this.log.error('Auth token is empty - please check instance configuration');\n            return;\n        }\n\n        if (!this.config.username) {\n            this.log.error('Username is empty - please check instance configuration');\n            return;\n        }\n\n        this.twitchApi = new TwitchApi(this.config.authToken, this.config.username, this.log);\n\n        try {\n            await this.twitchApi.initialize();\n        } catch (err: any) {\n            await this.setStateAsync('info.connection', { val: false, ack: true });\n            this.log.error(err);\n            return;\n        }\n\n        await this.setStateAsync('info.connection', { val: true, ack: true });\n\n        await this.createFolder('channels', 'Followed Twitch Channels');\n\n        this.updateFollowersInStore();\n\n        this.setInterval(() => {\n            this.updateFollowersInStore();\n        }, UPDATE_INTERVAL_IN_MILLISECONDS);\n    }\n\n    private async updateFollowersInStore(): Promise<void> {\n        this.log.debug('Updating Twich followers');\n\n        const [followers, liveStreams] = await Promise.all([\n            this.twitchApi.getFollowers(),\n            this.twitchApi.getLiveStreamsIFollow(),\n        ]);\n\n        if (!followers || followers.length === 0) {\n            return;\n        }\n\n        await this.cleanUpOldFollowers(followers);\n\n        for (const follower of followers) {\n            const followerName = follower.to_name;\n\n            const streamStatus = liveStreams.find((stream) => {\n                return stream.user_name === followerName;\n            });\n\n            const followerChannelId = `channels.${followerName}`;\n            await this.createFolder(followerChannelId, 'Followed Twitch Channel', followerName);\n            await this.createOrUpdateStates(followerChannelId, streamStatus);\n        }\n    }\n\n    private async cleanUpOldFollowers(followers: Array<IFollower>): Promise<void> {\n        const channels = await this.getChannelsAsync('channels');\n\n        const channelsToDelete = channels.filter((channel) => {\n            return !followers.find((follower: IFollower) => {\n                return follower.to_name === channel.native.twitchName;\n            });\n        });\n\n        for (const channelToDelete of channelsToDelete) {\n            this.log.debug(`Cleaning up unfollowed channel: ${channelToDelete._id}`);\n            await this.deleteChannelAsync('channels', channelToDelete._id);\n        }\n    }\n\n    private async createFolder(id: string, name: string, followerName?: string): Promise<any> {\n        await this.setObjectNotExistsAsync(id, {\n            type: 'channel',\n            common: {\n                name: name,\n            },\n            native: {\n                twitchName: followerName,\n            },\n        });\n    }\n\n    private async createOrUpdateStates(followerId: string, stream: IStream | undefined): Promise<any> {\n        for (const [stateNameInStore, defaultValuesAndLocation] of Object.entries(defaultFollowerKeysAndValues)) {\n            const stateName = `${followerId}.${stateNameInStore}`;\n\n            await this.setObjectNotExistsAsync(stateName, {\n                type: 'state',\n                common: {\n                    name: defaultValuesAndLocation.description,\n                    type: defaultValuesAndLocation.type as ioBroker.CommonType,\n                    role: 'indicator',\n                    read: true,\n                    write: false,\n                },\n                native: {},\n            });\n\n            let value = defaultValuesAndLocation.defaultValue;\n\n            if (stream) {\n                if (stateNameInStore === 'online') {\n                    value = true;\n                } else {\n                    value = (stream as any)[defaultValuesAndLocation.findIn];\n                }\n            }\n\n            await this.setStateAsync(stateName, { val: value, ack: true });\n        }\n    }\n\n    /**\n     * Is called when adapter shuts down - callback has to be called under any circumstances!\n     */\n    private onUnload(callback: () => void): void {\n        try {\n            this.setState('info.connection', { val: false, ack: true });\n            callback();\n        } catch (e) {\n            callback();\n        }\n    }\n\n    /**\n     * Is called if a subscribed state changes\n     */\n    private onStateChange(id: string, state: ioBroker.State | null | undefined): void {\n        if (state) {\n            // The state was changed\n            this.log.info(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\n        } else {\n            // The state was deleted\n            this.log.info(`state ${id} deleted`);\n        }\n    }\n}\n\nif (require.main !== module) {\n    // Export the constructor in compact mode\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Twitch(options);\n} else {\n    // otherwise start the instance directly\n    (() => new Twitch())();\n}\n"],
  "mappings": "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",
  "names": []
}
